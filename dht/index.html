
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.2">
    
    
      
        <title>Extending Telemetrix - Telemetrix and Telemetrix-AIO User's Guide</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.d451bc0e.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#extending-telemetrix" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Telemetrix and Telemetrix-AIO User&#39;s Guide" class="md-header__button md-logo" aria-label="Telemetrix and Telemetrix-AIO User's Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Telemetrix and Telemetrix-AIO User's Guide
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Extending Telemetrix
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/MrYsLab/telemetrix" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Telemetrix and Telemetrix-AIO User&#39;s Guide" class="md-nav__button md-logo" aria-label="Telemetrix and Telemetrix-AIO User's Guide" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Telemetrix and Telemetrix-AIO User's Guide
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/MrYsLab/telemetrix" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../contents/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    What Is Contained In This Guide?
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    System and Installation Requirements
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            System and Installation Requirements
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../python_3_verify/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Verifying Python 3 Version
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../python_install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python 3 Installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../install_telemetrix/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installing Telemetrix
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../install_telemetrix-aio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installing Telemetrix-AIO
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../telemetrix4arduino/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installing Telemetrix4Arduino
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../telemetrix4esp8266/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installing And Using Telemetrix4Esp8266
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../upgrade/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Upgrading To The Latest Version Python Clients
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../pins/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Specifying Pin Numbers
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    The Python APIs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            The Python APIs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../init/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The __init__ Method
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../pin_modes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setting Pin Modes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../enable_disable/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Enabling/Disabling Analog, Digital, and SONAR Reporting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../device_writes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Writing Values To Pins And Selected Devices
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../i2c/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    I2C Reads And Writes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../onewire/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OneWire Commands
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../spi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SPI Commands
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../stepper/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Stepper Commands
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Shutting Down
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../debug/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Debugging
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../license/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    License
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="extending-telemetrix">Extending Telemetrix</h1>
<p>The Telemetrix Project comes pre-packaged with support for a fixed set of sensors and 
actuators. But, what if you want to add support for something outside of the base set?</p>
<p>Telemetrix was designed specifically to allow you to extend its capabilities to 
customize it to meet your needs. Before going into a little detail about the 
infrastructure let's look at how the client and server exchange information.</p>
<h1 id="understanding-telemetrix-data-packets">Understanding Telemetrix Data Packets</h1>
<p>When an application wishes to control the server or when the server 
wishes to report data information back to the application, a Telemetrix Data Packet is 
formed and sent over the serial or WiFi link</p>
<p>For consistency, the format for both client and server packets is identical. </p>
<p>Let's take a look at the packet format.</p>
<h2 id="packet-format">Packet Format</h2>
<p><img src="../images/packet.png"></p>
<p>A Telemetrix Packet consists of 3 parts. The packet length, the packet ID and the payload.</p>
<h3 id="packet-id">Packet ID</h3>
<p>The packet ID contains either a command or report ID. These IDs are defined to be the 
same value for both client and server. This is shown in the examples below.</p>
<p>On the client side, command IDs are declared in
<a href="https://github.com/MrYsLab/telemetrix/blob/master/telemetrix/private_constants.py">private_constants.py</a>.</p>
<p>When creating a command packet the command method selects the appropriate command 
packed ID to use. </p>
<pre><code class="language-python"># commands
# send a loop back request - for debugging communications
LOOP_COMMAND = 0
SET_PIN_MODE = 1  # set a pin to INPUT/OUTPUT/PWM/etc
DIGITAL_WRITE = 2  # set a single digital pin value instead of entire port
ANALOG_WRITE = 3
</code></pre>
<p>On the server side, the IDs are declared in the
<a href="https://github.com/MrYsLab/Telemetrix4Arduino/blob/master/examples/Telemetrix4Arduino/Telemetrix4Arduino.ino">.ino</a>
file. </p>
<pre><code class="language-python">// Commands -received by this sketch
// Add commands retaining the sequential numbering.
// The order of commands here must be maintained in the command_table.
#define SERIAL_LOOP_BACK 0
#define SET_PIN_MODE 1
#define DIGITAL_WRITE 2
#define ANALOG_WRITE 3
</code></pre>
<p>The server uses the command packet ID to index into an array of function pointers used 
to implement the command.
This array is called the command table.</p>
<pre><code class="language-python">
command_descriptor command_table[] =
{
  {&amp;serial_loopback},
  {&amp;set_pin_mode},
  {&amp;digital_write},
  {&amp;analog_write},
</code></pre>
<p>When adding a new command 
Here is a partial list of command IDs.</p>
<pre><code class="language-python">
</code></pre>
<h3 id="packet-length">Packet Length</h3>
<p>The <em>payload length</em> and <em>packet ID</em> portions of the packet are each one byte in length. 
The total payload length is of variable size and is reflected in the payload length byte.</p>
<h1 id="a-high-level-view-of-adding-an-extension">A High Level View Of Adding An Extension</h1>
<h2 id="commands">Commands</h2>
<h2 id="reports">Reports</h2>
<h2 id="create-a-new-command">Create A New Command</h2>
<p>To command the server to perform ommands are implemented through calls to the API</p>
<p>Telemetrix is driven by the client and server  exchanging data
packets. To add new features, one must understand the structure and use of these packets.</p>
<p>The data packets originating from the client are called <em><strong>command</strong></em> packets. </p>
<p>The data packets originating from the server are called <em><strong>reporter</strong></em> packets.</p>
<p>The format for both command and reporter packets is the same.</p>
<h3 id="packet-id_1">Packet ID</h3>
<p>The packet ID is used by both the client and server to locate the 
When Telemetrix4Arduino receives a command in the 
<a href="https://github.com/MrYsLab/Telemetrix4Arduino/blob/275f58b98e336855deb677ae5f7406e5a253b469/examples/Telemetrix4Arduino/Telemetrix4Arduino.ino#L768">get_next_command</a> function, 
all of the bytes that follow the packet ID are placed into a command_buffer for 
processing. The ESP-8266 server behaves in the same manner.</p>
<p>When a Telemetrix client receives a report, the
 <a href="https://github.com/MrYsLab/telemetrix/blob/aebc7d985328c8d8c4de192d175e0792e5154637/telemetrix/telemetrix.py#L1063">_reporter</a> 
 method also places all of the bytes following the packet
ID into the response_data buffer for processing.</p>
<h3 id="the-packet-id">The Packet ID</h3>
<p>The packet ID identifies the command or report type. The packet ID drives the data 
processing of the system. </p>
<h3 id="building-and-sending-a-command-packet">Building And Sending A Command Packet</h3>
<p>To associate a GPIO digital input pin with a DHT device, the client application
calls the 
<a href="https://htmlpreview.github.io/?https://github.com/MrYsLab/telemetrix/blob/master/html/telemetrix/index.html#telemetrix.telemetrix.Telemetrix.set_pin_mode_dht">set_pin_mode_dht</a> method.</p>
<p>The <strong><em>set_pin_mode_dht</em></strong> method creates a list containing command packet values of the 
command ID, the GPIO pin-number and the DHT device type.</p>
<pre><code class="language-python">        command = [PrivateConstants.DHT_NEW, pin, dht_type]
        self._send_command(command)
</code></pre>
<p>The set_pin_mode_dht method then calls the _<strong><em>send_command</em></strong> utility method.  The length
of the command packet is calculated and placed as the first byte of the command. The 
command is then converted to a byte string and sent across the link.</p>
<pre><code class="language-python">def _send_command(self, command):
        &quot;&quot;&quot;
        This is a private utility method.
        :param command:  command data in the form of a list
        &quot;&quot;&quot;
        # the length of the list is added at the head
        command.insert(0, len(command))
        send_message = bytes(command)

        if self.serial_port:
            try:
                self.serial_port.write(send_message)
            except SerialException:
                if self.shutdown_on_exception:
                    self.shutdown()
                raise RuntimeError('write fail in _send_command')
        elif self.ip_address:
            self.sock.sendall(send_message)
        else:
            raise RuntimeError('No serial port or ip address set.')

</code></pre>
<p>The command variable is list populated with the command ID, DHT_NEW, the GPIO pin 
number, and a dht_type.</p>
<p>For commands, the 
server 
maintains an array of command handler function pointers. The packet ID is used as an 
index into the array to retrieve its associated command handler function. </p>
<p>For reports, the client maintains a dictionary of report handler methods. The packet ID 
is the key used to
retrieve the associated report handling method.</p>
<h2 id="preparing-for-the-new-extension">Preparing For The New Extension</h2>
<p>Before jumping directly into coding, you should consider a few things when designing your extension.</p>
<ol>
<li>
<p>Review the library's API to select the methods you wish to support.</p>
<p>You may support the complete set of library functions or a subset. For this example,
only the minimum functions will be supported to help keep things as simple as possible.</p>
<p>The library chosen for the DHT is the <a href="https://github.com/RobTillaart/DHTstable">DHTstable library</a>.</p>
</li>
<li>
<p>Determine if there is a time constraint on accessing the device.</p>
<p>The DHT 22, for example, can only be read every 2 seconds to receive valid data. 
  We will demonstrate how to support this restriction in a non-blocking manner.</p>
</li>
<li>
<p>Determine the number of instances of the device you wish to support.</p>
<p>For the DHT 22, up to six devices are supported.</p>
</li>
</ol>
<h2 id="implementing-the-new-extension">Implementing The New Extension</h2>
<h3 id="design-decisions">Design Decisions</h3>
<p>For the DHT, a new command method, called <strong><em>set_pin_mode_dht</em></strong>, is added to the client,
and an associated command handler is created on the server.</p>
<p>A new report is added for the server to notify the client of the latest humidity and 
temperature values retrieved from the DHT device. An associated report handler is added 
to the client.</p>
<p>The DHT feature is implemented on the server using the following DHTStable methods:</p>
<ul>
<li>read11</li>
<li>read22</li>
<li>getHumidity</li>
<li>getTemperature</li>
</ul>
<p>Note that this is only a subset of available methods provided by DHTStable.</p>
<h3 id="adding-a-new-command">Adding A New Command</h3>
<h4 id="client-side">Client Side</h4>
<p>First, add a new command ID to  <strong><em>private_constants.py.</em></strong></p>
<pre><code class="language-python"># commands
    # send a loop back request - for debugging communications
    LOOP_COMMAND = 0
    SET_PIN_MODE = 1  # set a pin to INPUT/OUTPUT/PWM/etc
    DIGITAL_WRITE = 2  # set a single digital pin value instead of entire port
    ANALOG_WRITE = 3
    MODIFY_REPORTING = 4
    GET_FIRMWARE_VERSION = 5
    ARE_U_THERE = 6  # Arduino ID query for auto-detect of telemetrix connected boards
    SERVO_ATTACH = 7
    SERVO_WRITE = 8
    SERVO_DETACH = 9
    I2C_BEGIN = 10
    I2C_READ = 11
    I2C_WRITE = 12
    SONAR_NEW = 13
    DHT_NEW = 14
</code></pre>
<p>DHT_NEW is the command that will be sent to the server.</p>
<h4 id="server-side">Server Side</h4>
<h3 id="adding-a-new-report">Adding A New Report</h3>
<h4 id="server-side_1">Server Side</h4>
<h4 id="client-side_1">Client Side</h4>
<h3 id="four-steps-to-add-the-new-command-and-its-report">Four Steps To Add The New Command And Its Report</h3>
<h4 id="1-modify-the-client">1. Modify The Client</h4>
<p>For DHT support, we are going to add a <strong><em>set_pin_mode_dht</em></strong> command. This command 
will instruct the server add a DHT to its list of DHT devices that it needs to monitor.</p>
<p>On the client side, this is the only new method we need to add.</p>
<p>On the server side, we will need to add code to accept the new command. The server 
also needs code to build a report message when it monitors the DHT devices.</p>
<p>The assumption is that the new extension will ultimately result in continuous report generation
 without any additional API calls. </p>
<p>Your device may have different requirements, and you will need to adjust things for your particular case.</p>
<h3 id="modifying-the-client-for-the-new-command">Modifying The Client For The New Command</h3>
<p>For DHT support, a single command will be added to associate a GPIO pin with a sensor.
To be consistent, we will call this command <strong><em>set_pin_mode_dht</em></strong>.</p>
<h4 id="1-add-a-constant-value-for-the-new-command">1. Add A Constant Value For The New Command</h4>
<p>Edit the private_constants.py file and add a value for the new command.</p>
<p>Below are the steps used for adding the DHT extension. We will use the <strong><em>telemetrix</em></strong> client for illustration
purposes. Modifying telemetrix-aio would take a similar approach. </p>
<p>The following sections discuss each step in detail.</p>
<ol>
<li>
<p>Add a new <strong>client</strong> command to be transmitted to the server.</p>
</li>
<li>
<p>Add a new command handler on the <strong>server</strong> to process the command.</p>
</li>
<li>
<p>Add a new function to the <strong>server</strong> to continuously monitor the device and generate data reports.</p>
</li>
<li>
<p>Add a new function to the <strong>client</strong> to handle the new incoming reports.</p>
</li>
</ol>
<h4 id="adding-a-new-client-command">Adding A New Client Command</h4>
<p><b>1. Define A New Command Value</b></p>

<p>To add a new command to the API, define a new command value in
<a href="https://github.com/MrYsLab/telemetrix/blob/master/telemetrix/private_constants.py">private_constants.py</a>.</p>
<pre><code class="language-python">class PrivateConstants:
    &quot;&quot;&quot;
    This class contains a set of constants for telemetrix internal use .
    &quot;&quot;&quot;

    # commands
    # send a loop back request - for debugging communications
    LOOP_COMMAND = 0
    SET_PIN_MODE = 1  # set a pin to INPUT/OUTPUT/PWM/etc
    DIGITAL_WRITE = 2  # set a single digital pin value instead of entire port
    ANALOG_WRITE = 3
    MODIFY_REPORTING = 4
    GET_FIRMWARE_VERSION = 5
    ARE_U_THERE = 6  # Arduino ID query for auto-detect of telemetrix connected boards
    SERVO_ATTACH = 7
    SERVO_WRITE = 8
    SERVO_DETACH = 9
    I2C_BEGIN = 10
    I2C_READ = 11
    I2C_WRITE = 12
    SONAR_NEW = 13
    DHT_NEW = 14 #&lt;-----------New Command For the DHT!!!!!!!!!!!!!
    STOP_ALL_REPORTS = 15
    SET_ANALOG_SCANNING_INTERVAL = 16
</code></pre>
<p>Here the command DHT_NEW was added.</p>
<p><b>2. Define the maximum number of DHT devices to be supported.</b></p>

<p>Add this value to private_contants.py</p>
<pre><code class="language-python"># Maximum number of dht devices allowed
 MAX_DHTS = 6
</code></pre>
<p><b>3. Add storage to telemetrix.py to keep track of the number of currently active DHT devices and
their associated callback functions.</b></p>

<pre><code class="language-python">self.dht_callbacks = {}

self.dht_count = 0
</code></pre>
<p>The dht_callbacks dictionary uses the pin number for the DHT device as a key to retrieve its associated callback 
function.</p>
<p>The dht_count variable keeps track of the number of currently active DHT devices.</p>
<p><b>4. Add a command method to telemetrix.py to command the server to add a new DHT device.</b></p>

<pre><code>def set_pin_mode_dht(self, pin, callback=None):
        &quot;&quot;&quot;
        :param pin: connection pin
        :param callback: callback function
        Error Callback: [Callback 0=DHT REPORT, DHT_ERROR=0, PIN, Error Number, Time]
        Valid Data Callback: Callback 0=DHT REPORT, DHT_DATA=1, PIN, Humidity, Temperature Time]
        &quot;&quot;&quot;

        if not callback:
            if self.shutdown_on_exception:
                self.shutdown()
            raise RuntimeError('set_pin_mode_dht: A Callback must be specified')

        if self.dht_count &lt; PrivateConstants.MAX_DHTS - 1:
            self.dht_callbacks[pin] = callback
            self.dht_count += 1

            command = [PrivateConstants.DHT_NEW, pin]
            self._send_command(command)
        else:
            if self.shutdown_on_exception:
                self.shutdown()
            raise RuntimeError(f'Maximum Number Of DHTs Exceeded - set_pin_mode_dht fails for pin {pin}')
</code></pre>
<p>The name set_pin_mode_dht, was chosen to stay consistent with the telemetrix naming conventions.
Because DHT devices generate reports, we ensure that the user specifies a callback function for the device.
The callback is added to dht_callbacks, and the number of active DHT devices is incremented. If the maximum number of DHT 
devices is exceeded, a RuntimeError is raised.  Otherwise, a command data packet is built and sent to the server.</p>
<p><strong>NOTE:</strong> The <a href="https://github.com/MrYsLab/telemetrix/blob/aebc7d985328c8d8c4de192d175e0792e5154637/telemetrix/telemetrix.py#L1007">_send_command</a>
 method will automatically calculate the payload length and append it to the packet.</p>
<h3 id="modifying-the-server">Modifying The Server</h3>
<h4 id="adding-a-new-server-command-handler">Adding A New Server Command Handler</h4>
<p><b>1. Add the library to the list of #includes</b></p>

<pre><code>#include &lt;Arduino.h&gt;
#include &quot;Telemetrix4Arduino.h&quot;
#include &lt;Servo.h&gt;
#include &lt;Ultrasonic.h&gt;
#include &lt;Wire.h&gt;
#include &lt;dhtnew.h&gt; // Adding dhtnew
</code></pre>
<p><b>2. Create A Name For The New Command Handler Function And Declare It As Extern</b></p>

<pre><code>// Create forward references for all the command handlers.
// If you add a new command, you must add the command handler
// here as well.

extern void serial_loopback();

extern void set_pin_mode();

extern void digital_write();

extern void analog_write();

extern void modify_reporting();

extern void get_firmware_version();

extern void are_you_there();

extern void servo_attach();

extern void servo_write();

extern void servo_detach();

extern void i2c_begin();

extern void i2c_read();

extern void i2c_write();

extern void sonar_new();

extern void dht_new(); // The New Command Handler

extern void stop_all_reports();

extern void set_analog_scanning_interval();
</code></pre>
<p><b>3. Define A Value For The Command That Matches The Value Defined In The Client</b></p>

<pre><code>// Commands -received by this sketch
// Add commands retaining the sequential numbering.
// The order of commands here must be maintained in the command_table.
#define SERIAL_LOOP_BACK 0
#define SET_PIN_MODE 1
#define DIGITAL_WRITE 2
#define ANALOG_WRITE 3
#define MODIFY_REPORTING 4 // mode(all, analog, or digital), pin, enable or disable
#define GET_FIRMWARE_VERSION 5
#define ARE_U_THERE 6
#define SERVO_ATTACH 7
#define SERVO_WRITE 8
#define SERVO_DETACH 9
#define I2C_BEGIN 10
#define I2C_READ 11
#define I2C_WRITE 12
#define SONAR_NEW 13
#define DHT_NEW 14 // The Command value
#define STOP_ALL_REPORTS 15
#define SET_ANALOG_SCANNING_INTERVAL 16

</code></pre>
<p><b>4. Update The Command Table With The New Command</b></p>

<p>The data structures are provided below. To update the table, increase
the size of the command_table to accept the new command.</p>
<p>The command_table contains pointers to the command functions. Note
that you may optionally specify the command without the &amp; operator. The
compiler interprets the entry the same way in both cases.</p>
<p>The command value defined above, the value 14 for DHTNEW, acts as an index 
into the command_table when fetching the function pointer. Make sure
to order the command_table appropriately.</p>
<pre><code>// When adding a new command update the command_table.
// The command length is the number of bytes that follow
// the command byte itself, and does not include the command
// byte in its length.
// The command_func is a pointer the command's function.
struct command_descriptor
{
    // a pointer to the command processing function
    void (*command_func)(void);
};

// An array of pointers to the command functions

// If you add new commands, make sure to extend the siz of this
// array.
command_descriptor command_table[17] =
    {
        {&amp;serial_loopback},
        {&amp;set_pin_mode},
        {&amp;digital_write},
        {&amp;analog_write},
        {&amp;modify_reporting},
        {&amp;get_firmware_version},
        {&amp;are_you_there},
        {&amp;servo_attach},
        {&amp;servo_write},
        {&amp;servo_detach},
        {&amp;i2c_begin},
        {&amp;i2c_read},
        {&amp;i2c_write},
        {&amp;sonar_new},
        {dht_new}, // The new function
        {stop_all_reports},
        {set_analog_scanning_interval}
    };
</code></pre>
<p><b>5. Create An Array Of DHT Descriptor Structures To Support The Feature</b></p>

<pre><code>
#define MAX_DHTS 6                // max number of devices

// DHT Descriptor
struct DHT
{
    uint8_t pin;
    unsigned int last_value;     // this value is reserved for future use
                                 // if a report should be generated
    DHTNEW *dht_sensor;
};

// an array of dht descriptor objects
DHT dhts[MAX_DHTS];

byte dht_index = 0; // index into the dhts array
</code></pre>
<p><b>6. Create The Command Handler Function</b></p>

<pre><code>/***********************************
 * DHT adding a new device
 **********************************/

void dht_new()
{
    int d_read;
    // report consists of:
    // 0 - byte count
    // 1 - report type
    // 2 - dht report subtype
    // 3 - pin number
    // 4 - error value

    // pre-build an error report in case of a read error
    byte report_message[5] = {4, (byte)DHT_REPORT, (byte)DHT_READ_ERROR, (byte)0, (byte)0};

    dhts[dht_index].dht_sensor = new DHTNEW((uint8_t)command_buffer[0]);
    dhts[dht_index].dht_sensor-&gt;setType();

    dhts[dht_index].pin = command_buffer[0];
    d_read = dhts[dht_index].dht_sensor-&gt;read();

    // if read return == zero it means no errors.
    if (d_read == 0)
    {
        dht_index++;
    }
    else
    {
        // error found
        // send report and release the dht object

        report_message[3] = command_buffer[0]; // pin number
        report_message[4] = d_read;
        Serial.write(report_message, 5);
        delete (dhts[dht_index].dht_sensor);
    }
}
</code></pre>
<p>When a DHT is added, a read is performed to see if there are any issues with the device.
If the read returns a zero, then there are no issues and nothing to report. However, a non-zero
value is an error indicator. The error value is returned as a report.</p>
<h3 id="add-a-new-server-function-to-continuously-monitor-the-device">Add A New Server Function To Continuously Monitor The Device</h3>
<p><b>1. Create A Device Scanner Function For Active DHT Devices</b></p>
<p>We are going to create the <em>scan_dhts</em> scanning function and then call the function in 
the loop section of the sketch.</p>
<p>The scan_dhts function prebuilds a report_message buffer assuming that the read
will return valid data.  The format for the report is shown in the comments for the function.
For valid data, the floating-point values are copied to the buffer as bytes, and a report is sent across the link.</p>
<p>If an error is returned as a result of the read, byte 2 of the report, the report sub-type is changed 
from DHT_DATA to DHT_ERROR, and the payload length is changed to a value of 4 bytes. The 
report is then 
sent across the serial link.</p>
<pre><code>void scan_dhts()
{
    // prebuild report for valid data
    // reuse the report if a read command fails

    // data returned is in floating-point form - 4 bytes
    // each for humidity and temperature

    // byte 0 = packet length
    // byte 1 = report type
    // byte 2 = report sub type - DHT_DATA or DHT_ERROR
    // btye 3 = pin number
    // byte 4 = humidity high order byte for data or error value
    // byte 5 = humidity byte 2
    // byte 6 = humidity byte 3
    // byte 7 = humidity byte 4
    // byte 8 = temperature high order byte for data or
    // byte 9 = temperature byte 2
    // byte 10 = temperature byte 3
    // byte 11 = temperature byte 4
    byte report_message[12] = {11, DHT_REPORT, DHT_DATA, 0, 0, 0, 0, 0, 0, 0, 0, 0};

    byte d_read;

    float dht_data;

    // are there any dhts to read?
    if (dht_index)
    {
        // is it time to do the read? This should occur every 2 seconds
        dht_current_millis = millis();
        if (dht_current_millis - dht_previous_millis &gt; dht_scan_interval)
        {
            // update for the next scan
            dht_previous_millis += dht_scan_interval;

            // read and report all the dht sensors
            for (int i = 0; i &lt; dht_index; i++)
            {
                report_message[3] = dhts[i].pin;
                // get humidity
                dht_data = dhts[i].dht_sensor-&gt;getHumidity();
                memcpy(&amp;report_message[4], &amp;dht_data, sizeof dht_data);

                // get temperature
                dht_data = dhts[i].dht_sensor-&gt;getTemperature();
                memcpy(&amp;report_message[8], &amp;dht_data, sizeof dht_data);

                Serial.write(report_message, 12);

                // now read do a read for this device for next go around
                d_read = dhts[i].dht_sensor-&gt;read();

                if (d_read)
                {
                    // error found
                    // send report
                    //send_debug_info(1, 1);
                    report_message[0] = 4;
                    report_message[1] = DHT_REPORT;
                    report_message[2] = DHT_READ_ERROR;
                    report_message[3] = dhts[i].pin; // pin number
                    report_message[4] = d_read;
                    Serial.write(report_message, 5);
                }
            }
        }
    }
}

</code></pre>
<p><b>2. Scan The Active DHT Sensors In The Sketch Loop Function</b></p>

<pre><code>void loop()
{
    // keep processing incoming commands
    get_next_command();

    if(! stop_reports){ // stop reporting
        scan_digital_inputs();
        scan_analog_inputs();
        scan_sonars();
        scan_dhts(); scan the active DHT sensors.
    }
}
</code></pre>
<h3 id="add-a-new-client-report-handler">Add a New Client Report Handler</h3>
<p><b>1. Add An Entry For The DHT Report To The Report Dispatch Dictionary</b></p>
<p>The report_dispatch dictionary uses report ID values as a key to look up the
handler for the incoming report. The dictionary update method is used when adding a new entry into 
the dispatch dictionary.</p>
<pre><code>        # The report_dispatch dictionary is used to process
        # incoming report messages by looking up the report message
        # and executing its associated processing method.

        self.report_dispatch = {}

        # To add a command to the command dispatch table, append here.
        self.report_dispatch.update({PrivateConstants.LOOP_COMMAND: self._report_loop_data})
        self.report_dispatch.update({PrivateConstants.DEBUG_PRINT: self._report_debug_data})
        self.report_dispatch.update({PrivateConstants.DIGITAL_REPORT: self._digital_message})
        self.report_dispatch.update({PrivateConstants.ANALOG_REPORT: self._analog_message})
        self.report_dispatch.update({PrivateConstants.FIRMWARE_REPORT: self._firmware_message})
        self.report_dispatch.update({PrivateConstants.I_AM_HERE_REPORT: self._i_am_here})
        self.report_dispatch.update({PrivateConstants.SERVO_UNAVAILABLE: self._servo_unavailable})
        self.report_dispatch.update({PrivateConstants.I2C_READ_REPORT: self._i2c_read_report})
        self.report_dispatch.update({PrivateConstants.I2C_TOO_FEW_BYTES_RCVD: self._i2c_too_few})
        self.report_dispatch.update({PrivateConstants.I2C_TOO_MANY_BYTES_RCVD: self._i2c_too_many})
        self.report_dispatch.update({PrivateConstants.SONAR_DISTANCE: self._sonar_distance_report})
        self.report_dispatch.update({PrivateConstants.DHT_REPORT: self._dht_report})
</code></pre>
<p><b>2. Create The Report Handler</b></p>

<p>This function builds a report, and looks up the callback function for the DHT device
using the reported pin number as the key and calls the callback function.</p>
<pre><code>def _dht_report(self, data):
        &quot;&quot;&quot;
        This is the dht report handler method.
        :param data:            data[0] = report sub type - DHT_DATA or DHT_ERROR
                                data[1] = pin number
                                data[2] = humidity high order byte or error value if DHT_ERROR
                                data[3] = humidity byte 2
                                data[4] = humidity byte 3
                                data[5] = humidity byte 4
                                data[6] = temperature high order byte for data
                                data[7] = temperature byte 2
                                data[8] = temperature byte 3
                                data[9] = temperature byte 4
        &quot;&quot;&quot;

        if data[0]:  # DHT_ERROR
            # error report
            # data[0] = report sub type, data[1] = pin, data[2] = error message
            if self.dht_callbacks[data[1]]:
                # Callback 0=DHT REPORT, DHT_ERROR=0, PIN, Error Number, Time
                message = [PrivateConstants.DHT_REPORT, data[0], data[1], data[2], time.time()]
                self.dht_callbacks[data[1]](message)
        else:
            # got valid data DHT_DATA
            f_humidity = bytearray(data[2:6])
            f_temperature = bytearray(data[6:])
            message = [PrivateConstants.DHT_REPORT, data[0], data[1],
                       (struct.unpack('&lt;f', f_humidity))[0],
                       (struct.unpack('&lt;f', f_temperature))[0],
                       time.time()]

            self.dht_callbacks[data[1]](message)
</code></pre>
<h2 id="coping-with-various-data-types-with-a-byte-oriented-serial-link">Coping With Various Data Types With A Byte-Oriented Serial Link</h2>
<p>When data is sent across the serial link, it is sent as a series of bytes.
Some data types, such as integers and floating-point values, are larger than a single byte. 
For the Telemetrix Project, an integer value is two bytes in length, 
and a floating-point value is four bytes in size.</p>
<p>The multi-byte values are disassembled into individual bytes before transmission 
when sending a value larger than a byte in length. 
When received, the individual bytes are reassembled into the original multi-byte 
value. For all data items that must be represented in this manner, by convention, 
the most significant byte (MSB) is the first byte transmitted, followed by all 
subsequent bytes in descending byte order.</p>
<p>For example, the DHT 22 sensor expresses temperature and humidity values as 
floating-point. To send a report containing these values to the client, they 
must first be converted to individual bytes.
Using a humidity/temperature report as an example, let's see how this is done. On the 
server side.
After data is retrieved from the DHT sensor,  a report message is 
created using the following format:</p>
<pre><code class="language-python">  // byte 0 = packet length
  // byte 1 = report type
  // byte 2 = report sub type - DHT_DATA or DHT_ERROR
  // byte 3 = pin number
  // byte 4 = dht type
  // byte 5 = humidity positivity flag 0=positive, 1= negative
  // byte 6 = temperature positivity flag 0=positive, 1= negative
  // byte 7 = humidity integer portion
  // byte 8 = humidity fractional portion
  // byte 9 = temperature integer portion
  // byte 10= temperature fractional portion
</code></pre>
<p>Although both temperature and humidity values are reported as floating-point values that
are 4 bytes in length each, we can use a "trick" to send these values using 3 bytes each.
We can do this because the integer portion, the value on the 
left side of the decimal point, and the fractional portion, the value on the right 
side of the decimal, are valued at less than 256.  As a result, we can send the 
integer and fractional portions as bytes. However, we do still need to be able to 
differentiate between positive and negative values. The value's positivity is checked, 
and a  flag is set to indicate if the value is positive or negative.<br />
As a result, a floating point value is represented in three bytes instead 
of four, making the data packet more efficient for transmission across the link.
Using humidity as an example, here is the code that
performs this conversion:</p>
<pre><code>float j, f;
          float humidity = dhts[i].dht_sensor-&gt;getHumidity();
          if (humidity &gt;= 0.0) {
            report_message[5] = 0;
          }
          else {
            report_message[5] = 1;
          }
          f = modff(humidity, &amp;j);
          report_message[7] = (uint8_t)j;
          report_message[8] = (uint8_t)(f * 100);
</code></pre>
<p>The humidity is retrieved by calling the DHTStable library method,  <em>getHumdity</em>.
The humidity's positivity is checked, and the positivity flag is appropriately 
set within the report message.   Then using the C library function <em>modff</em>, the integer portion 
of the value is separated from the fractional part. The integer portion is returned 
in "j," and the fractional part is returned in "f." The fractional part is 
multiplied by 100 to convert the value to an integer.</p>
<p>On the client side, the converted bytes need to be reassembled into floats before providing
the data values to the user application.</p>
<pre><code class="language-python">f_humidity = float(data[5] + data[6] / 100)
            if data[3]:
                f_humidity *= -1.0
</code></pre>
<p>Here, we retrieve the integer and fractional portions from the report message. The 
fractional part is divided by 100 to return it to a floating-point value, and then the
integer and fractional values are added together. Lastly, the positivity flag is 
checked to determine if the value is positive or negative and adjusted appropriately.</p>
<p><br>
<br></p>
<p>Copyright (C) 2020-21 Alan Yorinks. All Rights Reserved.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2020-2023 Alan Yorinks &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  Last  Modified: October 23, 2023

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.footer"], "search": "../assets/javascripts/workers/search.a264c092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.726fbb30.min.js"></script>
      
    
  </body>
</html>



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-5.1.6">
    
    
      
        <title>Extentending Telemetrix - Telemetrix and Telemtrix-AIO User's Guide</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4b9ffd7b.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#a-use-case-the-dht-22-sensor" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Telemetrix and Telemtrix-AIO User's Guide" class="md-header-nav__button md-logo" aria-label="Telemetrix and Telemtrix-AIO User's Guide">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Telemetrix and Telemtrix-AIO User's Guide
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Extentending Telemetrix
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Telemetrix and Telemtrix-AIO User's Guide" class="md-nav__button md-logo" aria-label="Telemetrix and Telemtrix-AIO User's Guide">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Telemetrix and Telemtrix-AIO User's Guide
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contents/" title="What Is Contained In This Guide?" class="md-nav__link">
      What Is Contained In This Guide?
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      System and Installation Requirements
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="System and Installation Requirements" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        System and Installation Requirements
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../python_3_verify/" title="Verifying Python 3 Version" class="md-nav__link">
      Verifying Python 3 Version
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../python_install/" title="Python 3 Installation" class="md-nav__link">
      Python 3 Installation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install_telemetrix/" title="Installing Telemetrix" class="md-nav__link">
      Installing Telemetrix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install_telemetrix-aio/" title="Installing Telemetrix-AIO" class="md-nav__link">
      Installing Telemetrix-AIO
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../telemetrix4arduino/" title="Installing Telemetrix4Arduino" class="md-nav__link">
      Installing Telemetrix4Arduino
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../upgrade/" title="Upgrading To The Latest Version Python Clients" class="md-nav__link">
      Upgrading To The Latest Version Python Clients
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      The Python APIs
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="The Python APIs" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        The Python APIs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../init/" title="The __init__ Method" class="md-nav__link">
      The __init__ Method
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../pin_modes/" title="Setting Pin Modes" class="md-nav__link">
      Setting Pin Modes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enable_disable/" title="Enabling/Disabling Analog And Digital Reporting" class="md-nav__link">
      Enabling/Disabling Analog And Digital Reporting
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../device_writes/" title="Writing Values To Pins And Selected Devices" class="md-nav__link">
      Writing Values To Pins And Selected Devices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../i2c/" title="I2C Reads And Writes" class="md-nav__link">
      I2C Reads And Writes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../management/" title="Shutting Down" class="md-nav__link">
      Shutting Down
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../debug/" title="Debugging" class="md-nav__link">
      Debugging
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Extentending Telemetrix
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Extentending Telemetrix" class="md-nav__link md-nav__link--active">
      Extentending Telemetrix
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-command-and-reporter-packets" class="md-nav__link">
    The Command And Reporter Packets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coping-with-various-data-types-with-a-byte-oriented-serial-link" class="md-nav__link">
    Coping With Various Data Types With A Byte-Oriented Serial Link
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-for-the-new-extension" class="md-nav__link">
    Preparing For The New Extension
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-the-new-extension" class="md-nav__link">
    Implementing The New Extension
  </a>
  
    <nav class="md-nav" aria-label="Implementing The New Extension">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-a-new-client-command" class="md-nav__link">
    Adding A New Client Command
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-a-new-server-command-handler" class="md-nav__link">
    Adding A New Server Command Handler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-a-new-server-function-to-continuously-monitor-the-device" class="md-nav__link">
    Add A New Server Function To Continuously Monitor The Device
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-a-new-client-report-handler" class="md-nav__link">
    Add a New Client Report Handler
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../about/" title="About" class="md-nav__link">
      About
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-command-and-reporter-packets" class="md-nav__link">
    The Command And Reporter Packets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coping-with-various-data-types-with-a-byte-oriented-serial-link" class="md-nav__link">
    Coping With Various Data Types With A Byte-Oriented Serial Link
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#preparing-for-the-new-extension" class="md-nav__link">
    Preparing For The New Extension
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-the-new-extension" class="md-nav__link">
    Implementing The New Extension
  </a>
  
    <nav class="md-nav" aria-label="Implementing The New Extension">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#adding-a-new-client-command" class="md-nav__link">
    Adding A New Client Command
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adding-a-new-server-command-handler" class="md-nav__link">
    Adding A New Server Command Handler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-a-new-server-function-to-continuously-monitor-the-device" class="md-nav__link">
    Add A New Server Function To Continuously Monitor The Device
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-a-new-client-report-handler" class="md-nav__link">
    Add a New Client Report Handler
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="a-use-case-the-dht-22-sensor">A Use Case - The DHT 22 Sensor</h1>
<p>The Telemetrix Project comes pre-packaged with support for a fixed set of sensors and actuators.
But, what if you want to add support for something outside of the base set?</p>
<p>In this section, you will learn how to add custom support for a sensor or actuator of your choosing.</p>
<p>We will be using the DHT 22 temperature/humidity sensor to 
illustrate how to extend the Telemetrix Project's capabilities for discussion purposes.</p>
<h2 id="the-command-and-reporter-packets">The Command And Reporter Packets</h2>
<p>The Telemetrix clients and server communicate by exchanging data packets over the serial link. </p>
<p>The data packets originating from the client are called <em>command</em> packets. </p>
<p>The data packets originating from the server are called <em>reporter</em> packets.</p>
<p>The format for both command and reporter packets is the same.</p>
<p><img src="../images/packet.png"></p>
<p>The <em>packet length</em> and <em>packet ID</em> portions of the packet are each one byte in length. 
The total payload length is of variable size.</p>
<p>The packet length byte represents the total length in bytes of the payload section of the packet.
Note that the length does not include the packet length byte.</p>
<p>When Telemetrix4Arduino receives a command in the 
<a href="https://github.com/MrYsLab/Telemetrix4Arduino/blob/275f58b98e336855deb677ae5f7406e5a253b469/examples/Telemetrix4Arduino/Telemetrix4Arduino.ino#L768">get_next_command</a> function, 
all of the bytes that follow the payload ID are placed into a command_buffer for processing.</p>
<p>When a Telemetrix client receives a report, the
 <a href="https://github.com/MrYsLab/telemetrix/blob/aebc7d985328c8d8c4de192d175e0792e5154637/telemetrix/telemetrix.py#L1063">_reporter</a> 
 method also places all of the bytes following the payload
ID into the response_data buffer for processing.</p>
<h2 id="coping-with-various-data-types-with-a-byte-oriented-serial-link">Coping With Various Data Types With A Byte-Oriented Serial Link</h2>
<p>When data is sent across the serial link, it is sent as a series of bytes.
Some data types, such as integers and floating-point values, are larger than a single byte.
For the Telemetrix Project, an integer value is two bytes in length, and a floating-point value is four bytes
in length.</p>
<p>When sending a value larger than a byte in length, the multi-byte values are disassembled into 
individual bytes before transmission.
When received, the individual bytes are reassembled into the original multi-byte value. 
 For all data items that must be represented in this manner, by convention, the most significant byte (MSB)
 is the first byte transmitted, followed by all subsequent bytes in descending byte order.</p>
<p>For example, the DHT 22 sensor expresses temperature and humidity values as floating-point. To send a report containing
these values to the client, they must first be converted to individual bytes.</p>
<p>Using humidity as an example, let's see how this is done:</p>
<pre><code>// get humidity
dht_data = dhts[i].dht_sensor-&gt;getHumidity();
memcpy(&amp;report_message[4], &amp;dht_data, sizeof dht_data);
</code></pre>

<p>The humidity is retrieved by calling the DHTNEW method,  <em>getHumdity</em>.
The floating-point value returned in dht_data is converted to bytes, by using
the memcpy function. In the example above, the bytes are copied into a report_message
buffer in MSB order.</p>
<p>On the client side, the converted bytes need to be reassembled into floats before providing
the data values to the user application.</p>
<pre><code class="python">f_humidity = bytearray(data[2:6])
f_temperature = bytearray(data[6:])
message = [PrivateConstants.DHT_REPORT, data[0], data[1],
           (struct.unpack('&lt;f', f_humidity))[0],
           (struct.unpack('&lt;f', f_temperature))[0],
           time.time()]
</code></pre>

<p>In the example above, the humidity and temperature values are first extracted from the incoming report
as bytearrays. Then using the Python struct library, the bytearrays are reassembled into their
 original floating-point values.</p>
<h2 id="preparing-for-the-new-extension">Preparing For The New Extension</h2>
<p>Before jumping directly into coding, there are a few things you should consider when designing
your extension.</p>
<ol>
<li>
<p>Review the library's API to select the methods you wish to support.</p>
<p>You may support the full set of library functions or a subset. For this example,
only the minimum functions will be supported to help keep things as simple as possible.</p>
<p>The library chosen for the DHT is the <a href="https://github.com/RobTillaart/DHTNew">dhtnew library</a>.</p>
</li>
<li>
<p>Determine if there is a time constraint on how often a device can be accessed.</p>
<p>The DHT 22, for example, can only be read every 2 seconds to receive valid data. 
  We will demonstrate how to support this restriction in a non-blocking manner.</p>
</li>
<li>
<p>Determine the number of instances of the device you wish to support.</p>
<p>For the DHT 22, up to six devices are supported.</p>
</li>
</ol>
<h2 id="implementing-the-new-extension">Implementing The New Extension</h2>
<p>Below are the steps used for adding the DHT extension. We will use the telemetrix client for illustration
purposes. Modifying telemetrix-aio would take a similar approach. </p>
<p>Each step will be discussed in detail in the following sections.
The assumption is that the new extension will ultimately result in continuous report generation
 without any additional API calls. 
Your device may have different requirements, and you will need to adjust things for your particular case.</p>
<ol>
<li>
<p>Add a new <strong>client</strong> command to be transmitted to the server.</p>
</li>
<li>
<p>Add a new command handler on the <strong>server</strong> to process the command.</p>
</li>
<li>
<p>Add a new function to the <strong>server</strong> to continuously monitor the device and generate data reports.</p>
</li>
<li>
<p>Add a new function to the <strong>client</strong> to handle the new incoming reports.</p>
</li>
</ol>
<h3 id="adding-a-new-client-command">Adding A New Client Command</h3>
<p><p><b>1. Define A New Command Value</b></p></p>
<p>To add a new command to the API, define a new command value in
<a href="https://github.com/MrYsLab/telemetrix/blob/master/telemetrix/private_constants.py">private_constants.py</a>.</p>
<pre><code class="python">class PrivateConstants:
    &quot;&quot;&quot;
    This class contains a set of constants for telemetrix internal use .
    &quot;&quot;&quot;

    # commands
    # send a loop back request - for debugging communications
    LOOP_COMMAND = 0
    SET_PIN_MODE = 1  # set a pin to INPUT/OUTPUT/PWM/etc
    DIGITAL_WRITE = 2  # set a single digital pin value instead of entire port
    ANALOG_WRITE = 3
    MODIFY_REPORTING = 4
    GET_FIRMWARE_VERSION = 5
    ARE_U_THERE = 6  # Arduino ID query for auto-detect of telemetrix connected boards
    SERVO_ATTACH = 7
    SERVO_WRITE = 8
    SERVO_DETACH = 9
    I2C_BEGIN = 10
    I2C_READ = 11
    I2C_WRITE = 12
    SONAR_NEW = 13
    DHT_NEW = 14 #&lt;-----------New Command For the DHT!!!!!!!!!!!!!
    STOP_ALL_REPORTS = 15
    SET_ANALOG_SCANNING_INTERVAL = 16
</code></pre>

<p>Here the command DHT_NEW was added.</p>
<p><b>2. Define the maximum number of DHT devices to be supported.</b></p>

<p>Add this value to private_contants.py</p>
<pre><code class="python"># Maximum number of dht devices allowed
 MAX_DHTS = 6
</code></pre>

<p><b>3. Add storage to telemetrix.py to keep track of the number of currently active DHT devices and
their associated callback functions.</b></p>

<pre><code class="python">self.dht_callbacks = {}

self.dht_count = 0
</code></pre>

<p>The dht_callbacks dictionary uses the pin number for the DHT device as a key to retrieve its associated callback 
function.</p>
<p>The dht_count variable keeps track of the number of currently active DHT devices.</p>
<p><b>4. Add a command method to telemetrix.py to command the server to add a new DHT device.</b></p>

<pre><code>def set_pin_mode_dht(self, pin, callback=None):
        &quot;&quot;&quot;
        :param pin: connection pin
        :param callback: callback function
        Error Callback: [Callback 0=DHT REPORT, DHT_ERROR=0, PIN, Error Number, Time]
        Valid Data Callback: Callback 0=DHT REPORT, DHT_DATA=1, PIN, Humidity, Temperature Time]
        &quot;&quot;&quot;

        if not callback:
            if self.shutdown_on_exception:
                self.shutdown()
            raise RuntimeError('set_pin_mode_dht: A Callback must be specified')

        if self.dht_count &lt; PrivateConstants.MAX_DHTS - 1:
            self.dht_callbacks[pin] = callback
            self.dht_count += 1

            command = [PrivateConstants.DHT_NEW, pin]
            self._send_command(command)
        else:
            if self.shutdown_on_exception:
                self.shutdown()
            raise RuntimeError(f'Maximum Number Of DHTs Exceeded - set_pin_mode_dht fails for pin {pin}')
</code></pre>

<p>The name set_pin_mode_dht, was chosen to stay consistent with the telemetrix naming conventions.
Because DHT devices generate reports, we ensure that the user specifies a callback function for the device.
The callback is added to dht_callbacks, and the number of active DHT devices is incremented. If the maximum number of DHT 
devices is exceeded, a RuntimeError is raised.  Otherwise, a command data packet is built and sent to the server.</p>
<p><strong>NOTE:</strong> The <a href="https://github.com/MrYsLab/telemetrix/blob/aebc7d985328c8d8c4de192d175e0792e5154637/telemetrix/telemetrix.py#L1007">_send_command</a>
 method will automatically calculate the packet length and append it to the packet.</p>
<h3 id="adding-a-new-server-command-handler">Adding A New Server Command Handler</h3>
<p><p><b>1. Add the library to the list of #includes</b></p></p>
<pre><code>#include &lt;Arduino.h&gt;
#include &quot;Telemetrix4Arduino.h&quot;
#include &lt;Servo.h&gt;
#include &lt;Ultrasonic.h&gt;
#include &lt;Wire.h&gt;
#include &lt;dhtnew.h&gt; // Adding dhtnew
</code></pre>

<p><b>2. Create A Name For The New Command Handler Function And Declare It As Extern</b></p>

<pre><code>// Create forward references for all the command handlers.
// If you add a new command, you must add the command handler
// here as well.

extern void serial_loopback();

extern void set_pin_mode();

extern void digital_write();

extern void analog_write();

extern void modify_reporting();

extern void get_firmware_version();

extern void are_you_there();

extern void servo_attach();

extern void servo_write();

extern void servo_detach();

extern void i2c_begin();

extern void i2c_read();

extern void i2c_write();

extern void sonar_new();

extern void dht_new(); // The New Command Handler

extern void stop_all_reports();

extern void set_analog_scanning_interval();
</code></pre>

<p><b>3. Define A Value For The Command That Matches The Value Defined In The Client</b></p>

<pre><code>// Commands -received by this sketch
// Add commands retaining the sequential numbering.
// The order of commands here must be maintained in the command_table.
#define SERIAL_LOOP_BACK 0
#define SET_PIN_MODE 1
#define DIGITAL_WRITE 2
#define ANALOG_WRITE 3
#define MODIFY_REPORTING 4 // mode(all, analog, or digital), pin, enable or disable
#define GET_FIRMWARE_VERSION 5
#define ARE_U_THERE 6
#define SERVO_ATTACH 7
#define SERVO_WRITE 8
#define SERVO_DETACH 9
#define I2C_BEGIN 10
#define I2C_READ 11
#define I2C_WRITE 12
#define SONAR_NEW 13
#define DHT_NEW 14 // The Command value
#define STOP_ALL_REPORTS 15
#define SET_ANALOG_SCANNING_INTERVAL 16

</code></pre>

<p><b>4. Update The Command Table With The New Command</b></p>

<p>The data structures are provided below. To update the table, increase
the size of the command_table to accept the new command.</p>
<p>The command_table contains pointers to the command functions. Note
that you may optionally specify the command without the &amp; operator. The
compiler interprets the entry the same way in both cases.</p>
<p>The command value defined above, the value 14 for DHTNEW, acts as an index 
into the command_table when fetching the function pointer. Make sure
to order the command_table appropriately.</p>
<pre><code>// When adding a new command update the command_table.
// The command length is the number of bytes that follow
// the command byte itself, and does not include the command
// byte in its length.
// The command_func is a pointer the command's function.
struct command_descriptor
{
    // a pointer to the command processing function
    void (*command_func)(void);
};

// An array of pointers to the command functions

// If you add new commands, make sure to extend the siz of this
// array.
command_descriptor command_table[17] =
    {
        {&amp;serial_loopback},
        {&amp;set_pin_mode},
        {&amp;digital_write},
        {&amp;analog_write},
        {&amp;modify_reporting},
        {&amp;get_firmware_version},
        {&amp;are_you_there},
        {&amp;servo_attach},
        {&amp;servo_write},
        {&amp;servo_detach},
        {&amp;i2c_begin},
        {&amp;i2c_read},
        {&amp;i2c_write},
        {&amp;sonar_new},
        {dht_new}, // The new function
        {stop_all_reports},
        {set_analog_scanning_interval}
    };
</code></pre>

<p><b>5. Create An Array Of DHT Descriptor Structures To Support The Feature</b></p>

<pre><code>
#define MAX_DHTS 6                // max number of devices

// DHT Descriptor
struct DHT
{
    uint8_t pin;
    unsigned int last_value;     // this value is reserved for future use
                                 // if a report should be generated
    DHTNEW *dht_sensor;
};

// an array of dht descriptor objects
DHT dhts[MAX_DHTS];

byte dht_index = 0; // index into the dhts array
</code></pre>

<p><b>6. Create The Command Handler Function</b></p>

<pre><code>/***********************************
 * DHT adding a new device
 **********************************/

void dht_new()
{
    int d_read;
    // report consists of:
    // 0 - byte count
    // 1 - report type
    // 2 - dht report subtype
    // 3 - pin number
    // 4 - error value

    // pre-build an error report in case of a read error
    byte report_message[5] = {4, (byte)DHT_REPORT, (byte)DHT_READ_ERROR, (byte)0, (byte)0};

    dhts[dht_index].dht_sensor = new DHTNEW((uint8_t)command_buffer[0]);
    dhts[dht_index].dht_sensor-&gt;setType();

    dhts[dht_index].pin = command_buffer[0];
    d_read = dhts[dht_index].dht_sensor-&gt;read();

    // if read return == zero it means no errors.
    if (d_read == 0)
    {
        dht_index++;
    }
    else
    {
        // error found
        // send report and release the dht object

        report_message[3] = command_buffer[0]; // pin number
        report_message[4] = d_read;
        Serial.write(report_message, 5);
        delete (dhts[dht_index].dht_sensor);
    }
}
</code></pre>

<p>When a DHT is added, a read is performed to see if there are any issues with the device.
If the read returns a zero, then there are no issues and nothing to report. However, a non-zero
value is an error indicator. The error value is returned as a report.</p>
<h3 id="add-a-new-server-function-to-continuously-monitor-the-device">Add A New Server Function To Continuously Monitor The Device</h3>
<p><b>1. Create A Device Scanner Function For Active DHT Devices</b></p>

<p>We are going to create the <em>scan_dhts</em> scanning function and then call the function in 
the loop section of the sketch.</p>
<p>The scan_dhts function prebuilds a report_message buffer assuming that the read
will return valid data.  The format for the report is shown in the comments for the function.
For valid data, the floating-point values are copied to the buffer as bytes, and a report is sent across the link.</p>
<p>If an error is returned as a result of the read, byte 2 of the report, the report sub-type is changed 
from DHT_DATA to DHT_ERROR, and the packet length is changed to a value of 4 bytes. The report is then 
sent across the serial link.</p>
<pre><code>void scan_dhts()
{
    // prebuild report for valid data
    // reuse the report if a read command fails

    // data returned is in floating point form - 4 bytes
    // each for humidity and temperature

    // byte 0 = packet length
    // byte 1 = report type
    // byte 2 = report sub type - DHT_DATA or DHT_ERROR
    // btye 3 = pin number
    // byte 4 = humidity high order byte for data or error value
    // byte 5 = humidity byte 2
    // byte 6 = humidity byte 3
    // byte 7 = humidity byte 4
    // byte 8 = temperature high order byte for data or
    // byte 9 = temperature byte 2
    // byte 10 = temperature byte 3
    // byte 11 = temperature byte 4
    byte report_message[12] = {11, DHT_REPORT, DHT_DATA, 0, 0, 0, 0, 0, 0, 0, 0, 0};

    byte d_read;

    float dht_data;

    // are there any dhts to read?
    if (dht_index)
    {
        // is it time to do the read? This should occur every 2 seconds
        dht_current_millis = millis();
        if (dht_current_millis - dht_previous_millis &gt; dht_scan_interval)
        {
            // update for the next scan
            dht_previous_millis += dht_scan_interval;

            // read and report all the dht sensors
            for (int i = 0; i &lt; dht_index; i++)
            {
                report_message[3] = dhts[i].pin;
                // get humidity
                dht_data = dhts[i].dht_sensor-&gt;getHumidity();
                memcpy(&amp;report_message[4], &amp;dht_data, sizeof dht_data);

                // get temperature
                dht_data = dhts[i].dht_sensor-&gt;getTemperature();
                memcpy(&amp;report_message[8], &amp;dht_data, sizeof dht_data);

                Serial.write(report_message, 12);

                // now read do a read for this device for next go around
                d_read = dhts[i].dht_sensor-&gt;read();

                if (d_read)
                {
                    // error found
                    // send report
                    //send_debug_info(1, 1);
                    report_message[0] = 4;
                    report_message[1] = DHT_REPORT;
                    report_message[2] = DHT_READ_ERROR;
                    report_message[3] = dhts[i].pin; // pin number
                    report_message[4] = d_read;
                    Serial.write(report_message, 5);
                }
            }
        }
    }
}

</code></pre>

<p><b>2. Scan The Active DHT Sensors In The Sketch Loop Function</b></p>

<pre><code>void loop()
{
    // keep processing incoming commands
    get_next_command();

    if(! stop_reports){ // stop reporting
        scan_digital_inputs();
        scan_analog_inputs();
        scan_sonars();
        scan_dhts(); scan the active DHT sensors.
    }
}
</code></pre>

<h3 id="add-a-new-client-report-handler">Add a New Client Report Handler</h3>
<p><b>1. Add An Entry For The DHT Report To The Report Dispatch Dictionary</b></p>

<p>The report_dispatch dictionary uses report ID values as a key to look up the
handler for the incoming report. The dictionary update method is used when adding a new entry into 
the dispatch dictionary.</p>
<pre><code># The report_dispatch dictionary is used to process
        # incoming report messages by looking up the report message
        # and executing its associated processing method.

        self.report_dispatch = {}

        # To add a command to the command dispatch table, append here.
        self.report_dispatch.update({PrivateConstants.LOOP_COMMAND: self._report_loop_data})
        self.report_dispatch.update({PrivateConstants.DEBUG_PRINT: self._report_debug_data})
        self.report_dispatch.update({PrivateConstants.DIGITAL_REPORT: self._digital_message})
        self.report_dispatch.update({PrivateConstants.ANALOG_REPORT: self._analog_message})
        self.report_dispatch.update({PrivateConstants.FIRMWARE_REPORT: self._firmware_message})
        self.report_dispatch.update({PrivateConstants.I_AM_HERE_REPORT: self._i_am_here})
        self.report_dispatch.update({PrivateConstants.SERVO_UNAVAILABLE: self._servo_unavailable})
        self.report_dispatch.update({PrivateConstants.I2C_READ_REPORT: self._i2c_read_report})
        self.report_dispatch.update({PrivateConstants.I2C_TOO_FEW_BYTES_RCVD: self._i2c_too_few})
        self.report_dispatch.update({PrivateConstants.I2C_TOO_MANY_BYTES_RCVD: self._i2c_too_many})
        self.report_dispatch.update({PrivateConstants.SONAR_DISTANCE: self._sonar_distance_report})
        self.report_dispatch.update({PrivateConstants.DHT_REPORT: self._dht_report})
</code></pre>

<p><b>2. Create The Report Handler</b></p>

<p>This function builds a report, and looks up the callback function for the DHT device
using the reported pin number as the key and calls the callback function.</p>
<pre><code>def _dht_report(self, data):
        &quot;&quot;&quot;
        This is the dht report handler method.
        :param data:            data[0] = report sub type - DHT_DATA or DHT_ERROR
                                data[1] = pin number
                                data[2] = humidity high order byte or error value if DHT_ERROR
                                data[3] = humidity byte 2
                                data[4] = humidity byte 3
                                data[5] = humidity byte 4
                                data[6] = temperature high order byte for data
                                data[7] = temperature byte 2
                                data[8] = temperature byte 3
                                data[9] = temperature byte 4
        &quot;&quot;&quot;

        if data[0]:  # DHT_ERROR
            # error report
            # data[0] = report sub type, data[1] = pin, data[2] = error message
            if self.dht_callbacks[data[1]]:
                # Callback 0=DHT REPORT, DHT_ERROR=0, PIN, Error Number, Time
                message = [PrivateConstants.DHT_REPORT, data[0], data[1], data[2], time.time()]
                self.dht_callbacks[data[1]](message)
        else:
            # got valid data DHT_DATA
            f_humidity = bytearray(data[2:6])
            f_temperature = bytearray(data[6:])
            message = [PrivateConstants.DHT_REPORT, data[0], data[1],
                       (struct.unpack('&lt;f', f_humidity))[0],
                       (struct.unpack('&lt;f', f_temperature))[0],
                       time.time()]

            self.dht_callbacks[data[1]](message)
</code></pre>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../debug/" title="Debugging" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Debugging
              </div>
            </div>
          </a>
        
        
          <a href="../about/" title="About" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                About
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.a0c4167b.min.js"></script>
      <script src="../assets/javascripts/bundle.fb26dd1d.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.37585f48.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>